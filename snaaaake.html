<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>
  <script>
    //set textures for each object from 1 - 4,
    //texture files are temporary for testing
    //purposes.
    var snakeTexture = 4;
    var pillTexture = 4;
    var portalTexture = 3;
    var wallTexture = 2;

    var MainGame = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:

        function MainGame() {
          Phaser.Scene.call(this, {
            key: 'MainGame'
          });
        },

      grid: null,
      snake: null,
      pellet: null,
      portal: null,
      portal2: null,
      cursors: null,
      scoreText: null,
      walls: null,

      UP: 0,
      DOWN: 1,
      LEFT: 2,
      RIGHT: 3,

      preload: function() {
        this.load.image('snake1', 'assets/theme1/snake.png')
        this.load.image('pill1', 'assets/theme1/pill.png')
        this.load.image('portal1', 'assets/theme1/portal.png')
        this.load.image('wall1', 'assets/theme1/wall.png')
        this.load.image('background1', 'assets/theme1/background.png')

        this.load.image('snake2', 'assets/theme2/snake.png')
        this.load.image('pill2', 'assets/theme2/pill.png')
        this.load.image('portal2', 'assets/theme2/portal.png')
        this.load.image('wall2', 'assets/theme2/wall.png')
        this.load.image('background2', 'assets/theme2/background.png')

        this.load.image('snake3', 'assets/theme3/snake.png')
        this.load.image('pill3', 'assets/theme3/pill.png')
        this.load.image('portal3', 'assets/theme3/portal.png')
        this.load.image('wall3', 'assets/theme3/wall.png')
        this.load.image('background3', 'assets/theme3/background.png')

        this.load.image('snake4', 'assets/theme4/snake.png')
        this.load.image('pill4', 'assets/theme4/pill.png')
        this.load.image('portal4', 'assets/theme4/portal.png')
        this.load.image('wall4', 'assets/theme4/wall.png')
        this.load.image('background4', 'assets/theme4/background.png')

        this.load.audio('police_car', 'assets/audio/police_car.mp3')
      },

      create: function() {
        sound = this.sound.add('police_car', { loop: true });
        sound.volume = 5
        sound.play();

        //grid = this.add.grid(0, 0, 800, 600, 20, 20, 0x000000, 1, 0xffffff, 0.5);
        //grid.setOrigin(0);
        //this.add.rectangle(0, 0, 800, 600)

        var Snake = new Phaser.Class({
          initialize:

            function Snake(scene, x, y) {
              this.headPosition = new Phaser.Geom.Point(x, y);

              this.body = scene.add.group();

              this.head = this.body.create(x * 20, y * 20, 'snake' + snakeTexture);

              this.head.setOrigin(0);

              this.alive = true;

              this.speed = 100;

              this.moveTime = 0;

              this.tail = new Phaser.Geom.Point(x, y);

              this.score = 0

              this.heading = null;
              this.direction = null;
            },

          update: function(time) {
            if (time >= this.moveTime) {
              return this.move(time);
            }
          },

          faceLeft: function() {
            if (this.direction === 0 || this.direction === 1 || this.direction === null) {
              this.heading = 2;
            }
          },

          faceRight: function() {
            if (this.direction === 0 || this.direction === 1 || this.direction === null) {
              this.heading = 3;
            }
          },

          faceUp: function() {
            if (this.direction === 2 || this.direction === 3 || this.direction === null) {
              this.heading = 0;
            }
          },

          faceDown: function() {
            if (this.direction === 2 || this.direction === 3 || this.direction === null) {
              this.heading = 1;
            }
          },

          move: function(time) {
            switch (this.heading) {
              case 2:
                this.headPosition.x = this.headPosition.x - 1
                break;

              case 3:
                this.headPosition.x = this.headPosition.x + 1
                break;

              case 0:
                this.headPosition.y = this.headPosition.y - 1
                break;

              case 1:
                this.headPosition.y = this.headPosition.y + 1
                break;
            }

            this.direction = this.heading;
            Phaser.Actions.ShiftPosition(this.body.getChildren(), this.headPosition.x * 20, this.headPosition.y * 20, 1, this.tail);
            this.moveTime = time + this.speed;
            return true;
          },

          grow: function() {
            var newPart = this.body.create(this.tail.x, this.tail.y, 'snake' + snakeTexture);
            newPart.setOrigin(0);
            if(this.speed != 40)
              this.speed--;
            scoreText.setText('Score: ' + snake.score)
          },


          collideWithFood: function(pill) {
            if (this.headPosition.x === (pill.x / 20) && this.headPosition.y === (pill.y / 20)) {
              pill.consume();
              for(var i = 0; i < 4; i++)
              {
                this.grow();
              }
              this.score += 2

              if(!(sound.rate >= 1.5))
                sound.rate += 0.03;
              console.log(sound.rate)
            }
          },

          collideWithPortal: function(portal) {
            if (this.headPosition.x === (portal.x / 20) && this.headPosition.y === (portal.y / 20)) {
              //portal.reset();
              this.headPosition.x = portal.sisterX / 20;
              this.headPosition.y = portal.sisterY / 20;
              return true;
            }
            return false;
          },

          collide: function(item)
          {
                if(this.headPosition.x === (item.x / 20) && this.headPosition.y === (item.y / 20))
                  return true;
                else {
                    return false;
                }
          }
        });

        var Pill = new Phaser.Class({

          Extends: Phaser.GameObjects.Image,

          initialize:

            function Pill(scene, x, y) {
              Phaser.GameObjects.Image.call(this, scene)

              this.setTexture('pill' + pillTexture);
              this.setPosition(x * 20, y * 20);
              this.setOrigin(0);

              this.total = 0;

              scene.children.add(this);
            },

          consume: function() {
            var x = Phaser.Math.Between(1, 38);
            var y = Phaser.Math.Between(1, 28);

            this.setPosition(x * 20, y * 20);
          }

        });

        var Portal = new Phaser.Class({
          Extends: Phaser.GameObjects.Image,

          initialize:

            function Portal(scene, x, y) {
              Phaser.GameObjects.Image.call(this, scene)

              this.setTexture("portal" + portalTexture)
              this.setPosition(x * 20, y * 20)
              this.setOrigin(0)
              this.sisterX = 0;
              this.sisterY = 0;
              scene.children.add(this)
            },

          link: function(portal) {
            this.sisterX = portal.x;
            this.sisterY = portal.y;
          },

          reset: function() {
            var x = Phaser.Math.Between(0, 39);
            var y = Phaser.Math.Between(0, 29);

            this.setPosition(x * 20, y * 20);
          },
        });

        var Wall = new Phaser.Class({
          Extends: Phaser.GameObjects.Image,

          initialize:

            function Wall(scene, x, y) {
              Phaser.GameObjects.Image.call(this, scene)
              this.setTexture("wall" + wallTexture)
              this.setPosition(x * 20, y * 20)
              this.setOrigin(0)
              scene.children.add(this)
            }
        });

        snake = new Snake(this, Math.floor(Math.random() * 38) + 1, Math.floor(Math.random() * 28) + 1);
        pill = new Pill(this, Math.floor(Math.random() * 38) + 1, Math.floor(Math.random() * 28) + 1);
        portal = new Portal(this, Math.floor(Math.random() * 38) + 1, Math.floor(Math.random() * 28) + 1);
        portal2 = new Portal(this, Math.floor(Math.random() * 38) + 1, Math.floor(Math.random() * 28) + 1);
        portal.link(portal2);
        portal2.link(portal);

        walls = this.add.group();
        for(var i = 0; i < 40; i++)
        {
          var wall = new Wall(this, i, 0)
          walls.add(wall);
        }
        for(var i = 0; i < 40; i++)
        {
            var wall = new Wall(this, i, 29)
            walls.add(wall);
        }
        for(var i = 0; i < 29; i++)
        {
            var wall = new Wall(this, 0, i)
            walls.add(wall);
        }
        for(var i = 0; i < 30; i++)
        {
            var wall = new Wall(this, 39, i)
            walls.add(wall);
        }

        cursors = this.input.keyboard.createCursorKeys();
        toDisplay = "Score: " + snake.score
        scoreText = this.add.text(16, 600, toDisplay, {
          fontSize: '32px'
        })
      },

      update: function(time, delta) {
        if (!snake.alive) {
          return;
        }

        if (cursors.left.isDown) {
          snake.faceLeft();
        } else if (cursors.right.isDown) {
          snake.faceRight();
        } else if (cursors.up.isDown) {
          snake.faceUp();
        } else if (cursors.down.isDown) {
          snake.faceDown();
        }

        if(cursors.space.isDown){
          cursors.space.reset();
          snake.grow();
        }

        if (snake.update(time)) {
          snake.collideWithFood(pill);
          if (!snake.collideWithPortal(portal)) {
            snake.collideWithPortal(portal2)
          }
        Phaser.Actions.Call(walls.getChildren(), function(item) {
          if(snake.collide(item))
          {
            sound.stop();
            this.scene.start('GameOver', {text: snake.score});
          }
        }, this);
        Phaser.Actions.Call(snake.body.getChildren(), function(item) {
            if(!(snake.head === item))
            {
              if(snake.collide(item))
              {
                  sound.stop();
                  this.scene.start('GameOver', {text: snake.score});
              }
            }
          }, this);
        }
      }
    })

    var GameOver = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:
      function GameOver()
      {
          Phaser.Scene.call(this, {key: 'GameOver'});
      },

      preload: function()
      {
        this.load.audio('gnomed', 'assets/audio/gnomed.mp3');
        this.load.image('dacoop', 'assets/dacoop.png')
      },

      create: function(data)
      {
        sound1 = this.sound.add('gnomed');
        sound1.play();

        localStorage.clear();
        if(localStorage.getItem("scoreboard") != null)
        {
          var highscore = JSON.parse(localStorage.getItem("scoreboard"))
          console.log(highscore)
        }
        else{
          console.log("it's gone")
        }

        var coop = this.add.image(400, 150, 'dacoop');
        this.key = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);
        this.key1 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.E);
        gameOver = this.add.text(100 , 250, "YOU DIED", {fontSize: '128px', color: '#f00'})
        score = this.add.text(100, 400, "Your score was:" + data.text, {fontSize:'64px'});
        reset = this.add.text(75, 500, "Press R to Retry. Press E to Return to Menu", {fontSize:'26px'})
      },

      update: function(time, delta){
        if(this.key.isDown){
          this.scene.start('MainGame');
        }
        if(this.key1.isDown){
          this.scene.start('TitleScreen');
        }
      }
    })

    var TitleScreen = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:
      function TitleScreen()
      {
          Phaser.Scene.call(this, {key: 'TitleScreen'});
      },

      cursors: null,

      preload: function()
      {
        //this.load.image('logo', 'assets/logo.png');
        this.load.audio('drunken_sailor', 'assets/audio/drunken_sailor.mp3');
      },

      create: function()
      {
        //this.add.image('logo', 100, 300);
        logo = this.add.text(200, 200, "SNAKE", {fontSize:'128px', color:'red'});
        start = this.add.text(140, 315, "Press SPACE to start!", {fontSize:'40px'});
        settings = this.add.text(90, 360, "Press S to access settings", {fontSize:'40px'});
        cursors = this.input.keyboard.createCursorKeys();
        keyControl = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);

        sound = this.sound.add('drunken_sailor', { loop: true });
        sound.play();
      },

      update: function()
      {
        if(cursors.space.isDown)
        {
          sound.stop();
          this.scene.start('MainGame');
        }
        if(keyControl.isDown)
        {
          sound.stop();
          this.scene.start('Settings');
        }
      }
    })

    var Settings = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:
      function Settings()
      {
          Phaser.Scene.call(this, {key: 'Settings'});
      },

      preload: function()
      {
        this.load.audio('wooden_bear', 'assets/audio/wooden_bear.mp3');
      },

      create: function()
      {
        gameOver = this.add.text(200, 200, "Settings", {fontSize: '80px', color: '#f00'})
        score = this.add.text(220, 270, "Select a theme", {fontSize:'40px'});
        score = this.add.text(125, 575, "S - Return to Main Menu", {fontSize:'40px'});
        keyControl = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);

        sound = this.sound.add('wooden_bear', { loop: true });
        sound.play();
      },

      update: function()
      {
        if(keyControl.isDown)
        {
          sound.stop();
          this.scene.start('TitleScreen');
        }
      }
    })

    var config = {
      type: Phaser.WEBGL,
      width: 800,
      height: 630,
      scene: [TitleScreen, Settings, MainGame, GameOver]
    };

    var game = new Phaser.Game(config);
  </script>
</body>

</html>

<!DOCTYPE html>
<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.15.1/dist/phaser-arcade-physics.min.js"></script>
</head>

<body>
  <script>
    var MainGame = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:

        function MainGame(data) {
          Phaser.Scene.call(this, {
            key: 'MainGame',
            theme: data.target
          });
        },

      grid: null,
      snake: null,
      pellet: null,
      portal: null,
      portal2: null,
      cursors: null,
      scoreText: null,
      walls: null,

      UP: 0,
      DOWN: 1,
      LEFT: 2,
      RIGHT: 3,

      preload: function() {
        this.load.image('snake', 'assets/' + theme + 'snake.png')
        this.load.image('pill', 'assets/' + theme + 'pill.png')
        this.load.image('portal', 'assets/' + theme + 'portal.png')
        this.load.image('wall', 'assets/' + theme + 'wall.png')
      },

      create: function() {
        grid = this.add.grid(0, 0, 800, 600, 20, 20, 0x000000, 1, 0xffffff, 0.5);
        grid.setOrigin(0);
        this.add.rectangle(0, 0, 800, 600)

        var Snake = new Phaser.Class({
          initialize:

            function Snake(scene, x, y) {
              this.headPosition = new Phaser.Geom.Point(x, y);

              this.body = scene.add.group();

              this.head = this.body.create(x * 20, y * 20, 'snake');

              this.head.setOrigin(0);

              this.alive = true;

              this.speed = 90;

              this.moveTime = 0;

              this.tail = new Phaser.Geom.Point(x, y);

              this.score = 0

              this.heading = null;
              this.direction = null;
            },

          update: function(time) {
            if (time >= this.moveTime) {
              return this.move(time);
            }
          },

          faceLeft: function() {
            if (this.direction === 0 || this.direction === 1 || this.direction === null) {
              this.heading = 2;
            }
          },

          faceRight: function() {
            if (this.direction === 0 || this.direction === 1 || this.direction === null) {
              this.heading = 3;
            }
          },

          faceUp: function() {
            if (this.direction === 2 || this.direction === 3 || this.direction === null) {
              this.heading = 0;
            }
          },

          faceDown: function() {
            if (this.direction === 2 || this.direction === 3 || this.direction === null) {
              this.heading = 1;
            }
          },

          move: function(time) {
            switch (this.heading) {
              case 2:
                this.headPosition.x = this.headPosition.x - 1
                break;

              case 3:
                this.headPosition.x = this.headPosition.x + 1
                break;

              case 0:
                this.headPosition.y = this.headPosition.y - 1
                break;

              case 1:
                this.headPosition.y = this.headPosition.y + 1
                break;
            }

            this.direction = this.heading;
            Phaser.Actions.ShiftPosition(this.body.getChildren(), this.headPosition.x * 20, this.headPosition.y * 20, 1, this.tail);
            this.moveTime = time + this.speed;
            return true;
          },

          grow: function() {
            var newPart = this.body.create(this.tail.x, this.tail.y, 'snake');
            newPart.setOrigin(0);
            scoreText.setText('Score: ' + snake.score)
          },


          collideWithFood: function(pill) {
            if (this.headPosition.x === (pill.x / 20) && this.headPosition.y === (pill.y / 20)) {
              pill.consume();
              this.grow();

              this.score += 1
              if(speed != 40)
                speed--;
            }
          },

          collideWithPortal: function(portal) {
            if (this.headPosition.x === (portal.x / 20) && this.headPosition.y === (portal.y / 20)) {
              //portal.reset();
              this.headPosition.x = portal.sisterX / 20;
              this.headPosition.y = portal.sisterY / 20;
              return true;
            }
            return false;
          },

          collide: function(item)
          {
                if(this.headPosition.x === (item.x / 20) && this.headPosition.y === (item.y / 20))
                  return true;
                else {
                    return false;
                }
          }
        });

        var Pill = new Phaser.Class({

          Extends: Phaser.GameObjects.Image,

          initialize:

            function Pill(scene, x, y) {
              Phaser.GameObjects.Image.call(this, scene)

              this.setTexture('pill');
              this.setPosition(x * 20, y * 20);
              this.setOrigin(0);

              this.total = 0;

              scene.children.add(this);
            },

          consume: function() {
            var x = Phaser.Math.Between(1, 38);
            var y = Phaser.Math.Between(1, 28);

            this.setPosition(x * 20, y * 20);
          }

        });

        var Portal = new Phaser.Class({
          Extends: Phaser.GameObjects.Image,

          initialize:

            function Portal(scene, x, y) {
              Phaser.GameObjects.Image.call(this, scene)

              this.setTexture("portal")
              this.setPosition(x * 20, y * 20)
              this.setOrigin(0)
              this.sisterX = 0;
              this.sisterY = 0;
              scene.children.add(this)
            },

          link: function(portal) {
            this.sisterX = portal.x;
            this.sisterY = portal.y;
          },

          reset: function() {
            var x = Phaser.Math.Between(0, 39);
            var y = Phaser.Math.Between(0, 29);

            this.setPosition(x * 20, y * 20);
          },
        });

        var Wall = new Phaser.Class({
          Extends: Phaser.GameObjects.Image,

          initialize:

            function Wall(scene, x, y) {
              Phaser.GameObjects.Image.call(this, scene)
              this.setTexture("wall")
              this.setPosition(x * 20, y * 20)
              this.setOrigin(0)
              scene.children.add(this)
            }
        });



        snake = new Snake(this, Math.floor(Math.random() * 38) + 1, Math.floor(Math.random() * 28) + 1);
        pill = new Pill(this, Math.floor(Math.random() * 38) + 1, Math.floor(Math.random() * 28) + 1);
        portal = new Portal(this,  Math.floor(Math.random() * 38) + 1, Math.floor(Math.random() * 28) + 1);
        portal2 = new Portal(this,  Math.floor(Math.random() * 38) + 1, Math.floor(Math.random() * 28) + 1);
        portal.link(portal2);
        portal2.link(portal);

        walls = this.add.group();
        for(var i = 0; i < 40; i++)
        {
          var wall = new Wall(this, i, 0)
          walls.add(wall);
        }
        for(var i = 0; i < 40; i++)
        {
            var wall = new Wall(this, i, 29)
            walls.add(wall);
        }
        for(var i = 0; i < 29; i++)
        {
            var wall = new Wall(this, 0, i)
            walls.add(wall);
        }
        for(var i = 0; i < 30; i++)
        {
            var wall = new Wall(this, 39, i)
            walls.add(wall);
        }

        cursors = this.input.keyboard.createCursorKeys();
        toDisplay = "Score: " + snake.score
        scoreText = this.add.text(16, 600, toDisplay, {
          fontSize: '32px'
        })
      },

      update: function(time, delta) {
        if (!snake.alive) {
          return;
        }

        if (cursors.left.isDown) {
          snake.faceLeft();
        } else if (cursors.right.isDown) {
          snake.faceRight();
        } else if (cursors.up.isDown) {
          snake.faceUp();
        } else if (cursors.down.isDown) {
          snake.faceDown();
        }

        if (snake.update(time)) {
          snake.collideWithFood(pill);
          if (!snake.collideWithPortal(portal)) {
            snake.collideWithPortal(portal2)
          }
        Phaser.Actions.Call(walls.getChildren(), function(item) {
          if(snake.collide(item))
            this.scene.start('GameOver', {text: snake.score});
        }, this);
        Phaser.Actions.Call(snake.body.getChildren(), function(item) {
            if(!(snake.head === item))
            {
              if(snake.collide(item))
                this.scene.start('GameOver', {text: snake.score});
            }
          }, this);
        }
      }
    })

    var GameOver = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:
      function GameOver()
      {
          Phaser.Scene.call(this, {key: 'GameOver'});
      },

      create: function(data)
      {
        this.key = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);
        gameOver = this.add.text(100 , 250, "YOU DIED", {fontSize: '128px', color: '#f00'})
        score = this.add.text(100, 400, "Your score was:" + data.text, {fontSize:'64px'});
        reset = this.add.text(43, 500, "Press R to Retry. Press Esc to Return to Menu", {fontSize:'26px'})
      },

      update: function(time, delta){
        if(this.key.isDown){
          this.scene.start('MainGame');
        }
      }
    })

    var TitleScreen = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:
      function TitleScreen()
      {
          Phaser.Scene.call(this, {key: 'TitleScreen'});
      },

      key1: null,
      cursors: null,

      create: function()
      {
        gameOver = this.add.text(200, 200, "SNAKE", {fontSize: '128px', color: '#f00'})
        score = this.add.text(190, 320, "SPACE to start!", {fontSize:'48px'});
        score = this.add.text(230, 370, "S - Settings", {fontSize:'48px'});
        cursors = this.input.keyboard.createCursorKeys();

        key1 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
      },

      update: function()
      {
        if(cursors.space.isDown)
          this.scene.start('MainGame', {target: 'theme1'});
        if(key1.isDown)
        {
          this.scene.start('Settings')
        }
      }
    })

    var Settings = new Phaser.Class({
      Extends: Phaser.Scene,

      initialize:
      function Settings()
      {
          Phaser.Scene.call(this, {key: 'Settings'});
      },

      key1: null,
      cursors: null,

      create: function()
      {
        gameOver = this.add.text(250, 200, "Settings", {fontSize: '64px', color: '#f00'})
        score = this.add.text(170, 260, "S - Return to Main", {fontSize:'48px'});
        key1 = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.S);
      },

      update: function()
      {
        if(key1.isDown)
        {
          this.scene.start('TitleScreen')
        }
      }
    })

    var config = {
      type: Phaser.WEBGL,
      width: 800,
      height: 630,
      scene: [TitleScreen, Settings, MainGame, GameOver]
    };

    var game = new Phaser.Game(config);
  </script>
</body>

</html>
